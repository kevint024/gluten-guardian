<!DOCTYPE html>
<html>
<head>
    <title>Gluten Guardian - Production Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4CAF50; }
        .error { background: #ffeaea; border-color: #f44336; }
        .loading { background: #fff3cd; border-color: #ffc107; }
        button { padding: 10px 20px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>🧪 Gluten Guardian - Production Test</h1>
    <p>This page tests the key functionality that will work on GitHub Pages.</p>
    
    <div class="test">
        <h3>📡 API Connectivity Test</h3>
        <button onclick="testAPI()">Test Open Food Facts API</button>
        <div id="api-result"></div>
    </div>
    
    <div class="test">
        <h3>🔍 Barcode Lookup Test</h3>
        <button onclick="testBarcode()">Test Nutella Barcode (3017620422003)</button>
        <div id="barcode-result"></div>
    </div>
    
    <div class="test">
        <h3>🌾 Ingredient Analysis Test</h3>
        <button onclick="testIngredients()">Test Gluten Detection</button>
        <div id="ingredients-result"></div>
    </div>
    
    <div class="test">
        <h3>💾 Local Storage Test</h3>
        <button onclick="testStorage()">Test Browser Storage</button>
        <div id="storage-result"></div>
    </div>

    <script>
        // Minimal gluten ingredients list for testing
        const GLUTEN_INGREDIENTS = ['wheat', 'flour', 'gluten', 'barley', 'rye', 'malt'];
        
        function setResult(elementId, message, type = 'loading') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = type;
        }
        
        async function testAPI() {
            setResult('api-result', '🔄 Testing API connectivity...', 'loading');
            
            try {
                const response = await fetch('https://world.openfoodfacts.org/api/v0/product/3017620422003.json');
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    setResult('api-result', `✅ API works! Found: ${data.product.product_name || 'Unknown Product'}`, 'success');
                } else {
                    setResult('api-result', '❌ API responded but no product found', 'error');
                }
            } catch (error) {
                setResult('api-result', `❌ API Error: ${error.message}`, 'error');
            }
        }
        
        async function testBarcode() {
            setResult('barcode-result', '🔄 Testing barcode lookup...', 'loading');
            
            try {
                const barcode = '3017620422003';
                const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1 && data.product) {
                    const product = data.product;
                    const ingredients = product.ingredients_text || 'No ingredients available';
                    const hasGluten = GLUTEN_INGREDIENTS.some(ingredient => 
                        ingredients.toLowerCase().includes(ingredient.toLowerCase())
                    );
                    
                    setResult('barcode-result', 
                        `✅ Product: ${product.product_name}<br>` +
                        `🏷️ Brand: ${product.brands || 'Unknown'}<br>` +
                        `🌾 Contains Gluten: ${hasGluten ? 'YES ❌' : 'NO ✅'}<br>` +
                        `📝 Ingredients: ${ingredients.substring(0, 100)}...`, 'success');
                } else {
                    setResult('barcode-result', '❌ Product not found', 'error');
                }
            } catch (error) {
                setResult('barcode-result', `❌ Error: ${error.message}`, 'error');
            }
        }
        
        function testIngredients() {
            setResult('ingredients-result', '🔄 Testing ingredient analysis...', 'loading');
            
            const testCases = [
                { ingredients: 'rice, water, salt', expected: false },
                { ingredients: 'wheat flour, sugar, eggs', expected: true },
                { ingredients: 'chicken, vegetables, spices', expected: false },
                { ingredients: 'bread crumbs, meat, herbs', expected: true }
            ];
            
            let results = '✅ Ingredient Analysis Results:<br><br>';
            
            testCases.forEach((test, index) => {
                const hasGluten = GLUTEN_INGREDIENTS.some(ingredient => 
                    test.ingredients.toLowerCase().includes(ingredient.toLowerCase())
                );
                
                const correct = hasGluten === test.expected;
                const status = correct ? '✅' : '❌';
                
                results += `${status} Test ${index + 1}: "${test.ingredients}"<br>`;
                results += `   Expected gluten: ${test.expected ? 'YES' : 'NO'}, Detected: ${hasGluten ? 'YES' : 'NO'}<br><br>`;
            });
            
            setResult('ingredients-result', results, 'success');
        }
        
        function testStorage() {
            setResult('storage-result', '🔄 Testing local storage...', 'loading');
            
            try {
                // Test localStorage
                const testKey = 'gluten-guardian-test';
                const testValue = { test: true, timestamp: Date.now() };
                
                localStorage.setItem(testKey, JSON.stringify(testValue));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                if (retrieved && retrieved.test === true) {
                    localStorage.removeItem(testKey);
                    setResult('storage-result', '✅ Local storage works! Favorites and cache will persist.', 'success');
                } else {
                    setResult('storage-result', '❌ Local storage test failed', 'error');
                }
            } catch (error) {
                setResult('storage-result', `❌ Storage Error: ${error.message}`, 'error');
            }
        }
        
        // Auto-run tests on page load
        window.onload = function() {
            console.log('🧪 Production test page loaded');
            setTimeout(testAPI, 1000);
        };
    </script>
</body>
</html>
